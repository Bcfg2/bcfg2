.. -*- mode: rst -*-

.. _quickstart-centos:
.. _EPEL: http://fedoraproject.org/wiki/EPEL

=====================
Quickstart for CentOS
=====================

This is a complete getting started guide for CentOS. With this document you should be able to install a Bcfg2 server, a Bcfg2 client, and change the ``/etc/motd`` file on the client.

Install Bcfg2 From RPM
======================

The fastest way to get Bcfg2 onto your system is to get a RPM someone else has already made. We'll be using the ones that are distributed through EPEL_, but depending on your aversion to risk you could download an RPM from other places as well. See :ref:`using_bcfg2-with-centos` for information about building Bcfg2 from source and making your own packages.

Using EPEL
----------

 * Make sure EPEL is a valid repository on your server. The `instructions <http://fedoraproject.org/wiki/EPEL/FAQ#howtouse>`_ on how to do this basically say::

    # su -c 'rpm -Uvh http://download.fedora.redhat.com/pub/epel/5/i386/epel-release-5-3.noarch.rpm'
    ...lot's of output...


 * Install the bcfg2-server and bcfg2 RPMs ::

    $ sudo yum install bcfg2-server bcfg2

Your system should now have the necessary software to use Bcfg2. The next step is to set up your Bcfg2 :term:`repository`.

Initialize your repository
==========================
*This section needs to be updated for v1*

Now that you're done with the install, you need to initialize your 
repository and setup your ``/etc/bcfg2.conf``. ``bcfg2-admin init`` 
is a tool which allows you to automate this::

    [root@centos ~]# bcfg2-admin init
    Store bcfg2 configuration in [/etc/bcfg2.conf]:
    Location of bcfg2 repository [/var/lib/bcfg2]:
    Input password used for communication verification (without echoing; leave blank for a random):
    What is the server's hostname: [centos]
    Input the server location [https://centos:6789]:
    Input base Operating System for clients:
    1: Redhat/Fedora/RHEL/RHAS/Centos
    2: SUSE/SLES
    3: Mandrake
    4: Debian
    5: Ubuntu
    6: Gentoo
    7: FreeBSD
    : 1
    Generating a 2048 bit RSA private key
    .........................+++
    ..................+++
    writing new private key to '/etc/bcfg2.key'
    -----
    Signature ok
    subject=/C=US=ST=Illinois/L=Argonne/CN=centos
    Getting Private key
    Repository created successfuly in /var/lib/bcfg2

Change responses as necessary

Start the server
================

You are now ready to start your bcfg2 server for the first time::

    $ sudo /sbin/service bcfg2-server start

To verify that everything started ok, look for the running daemon and check the logs::

    $ sudo /sbin/service bcfg2-server status
    $ sudo tail /var/log/messages
    Mar 29 12:42:26 centos bcfg2-server[5093]: service available at https://centos:6789
    Mar 29 12:42:26 centos bcfg2-server[5093]: serving bcfg2-server at https://centos:6789
    Mar 29 12:42:26 centos bcfg2-server[5093]: serve_forever() [start]
    Mar 29 12:42:41 centos bcfg2-server[5093]: Handled 16 events in 0.007s

Run bcfg2 to be sure you are able to communicate with the server::

    [root@centos ~]# bcfg2 -vqn
    No ca is specified. Cannot authenticate the server with SSL.
    No ca is specified. Cannot authenticate the server with SSL.
    Loaded plugins: fastestmirror
    Loading mirror speeds from cached hostfile
    Excluding Packages in global exclude list
    Finished
    Loaded tool drivers:
     Action       Chkconfig  POSIX        YUMng

    Phase: initial
    Correct entries:        0
    Incorrect entries:      0
    Total managed entries:  0
    Unmanaged entries:      208


    Phase: final
    Correct entries:        0
    Incorrect entries:      0
    Total managed entries:  0
    Unmanaged entries:      208

    No ca is specified. Cannot authenticate the server with SSL.

The ca message is just a warning, meaning that the client does not
have sufficient information to verify that it is talking to the
correct server. This can be fixed by distributing the ca certificate
from the server to all clients. By default, this file is available in
/etc/bcfg2.crt on the server. Copy this file to the client (with a
bundle) and add the ca option to bcfg2.conf pointing at the file, and
the client will be able to verify it is talking to the correct server
upon connection::

    [root@centos-client ~]# cat /etc/bcfg2.conf


    [communication]
    protocol = xmlrpc/ssl
    password = N41lMNeW
    ca = /etc/bcfg2.crt

    [components]
    bcfg2 = https://centos:6789

Now if you run the client, no more warning::

    [root@centos ~]# bcfg2 -vqn
    Loaded plugins: fastestmirror
    Loading mirror speeds from cached hostfile
    Excluding Packages in global exclude list
    Finished
    Loaded tool drivers:
     Action       Chkconfig  POSIX        YUMng

    Phase: initial
    Correct entries:        0
    Incorrect entries:      0
    Total managed entries:  0
    Unmanaged entries:      208


    Phase: final
    Correct entries:        0
    Incorrect entries:      0
    Total managed entries:  0
    Unmanaged entries:      208

Bring your first machine under Bcfg2 control
--------------------------------------------

Now it is time to get your first machine's configuration into your
Bcfg2 repository. Let's start with the server itself.


Setup the `Packages`_ plugin
++++++++++++++++++++++++++++

.. _Packages: http://trac.mcs.anl.gov/projects/bcfg2/wiki/Plugins/Packages

First, replace **Pkgmgr** with **Packages** in the plugins
line of ``bcfg2.conf``.  Then create Packages layout (as per
:ref:`packages-exampleusage`) in ``/var/lib/bcfg2``

.. note:: I am using the RawURL syntax here since we are using `mrepo`_
to manage our yum mirrors.

.. _mrepo: http://dag.wieers.com/home-made/mrepo/

.. code-block:: xml

    <Sources>
            <!-- CentOS (5.4) sources -->
            <YUMSource>
                    <Group>centos5.4</Group>
                    <RawURL>http://mrepo/centos5-x86_64/RPMS.os</RawURL>
                    <Arch>x86_64</Arch>
            </YUMSource>
            <YUMSource>
                    <Group>centos5.4</Group>
                    <RawURL>http://mrepo/centos5-x86_64/RPMS.updates</RawURL>
                    <Arch>x86_64</Arch>
            </YUMSource>
            <YUMSource>
                    <Group>centos5.4</Group>
                    <RawURL>http://mrepo/centos5-x86_64/RPMS.extras</RawURL>
                    <Arch>x86_64</Arch>
            </YUMSource>
    </Sources>

Due to the `Magic Groups`_, we need to modify our Metadata. Let's
add a **centos5.4** group which inherits a **centos** group
(this should replace the existing **redhat** group) present in
``/var/lib/bcfg2/Metadata/groups.xml``. The resulting file should look
something like this

.. _Magic Groups: http://trac.mcs.anl.gov/projects/bcfg2/wiki/Plugins/Packages#MagicGroups

.. code-block:: xml

    <Groups version='3.0'>
       <Group profile='true' public='true' default='true' name='basic'>
          <Group name='centos5.4'/>
       </Group>
       <Group name='centos5.4'>
          <Group name='centos'/>
       </Group>
       <Group name='ubuntu'/>
       <Group name='debian'/>
       <Group name='freebsd'/>
       <Group name='gentoo'/>
       <Group name='centos'/>
       <Group name='suse'/>
       <Group name='mandrake'/>
       <Group name='solaris'/>
    </Groups>

.. note::
    When editing your xml files by hand, it is useful to occasionally run
    `bcfg2-repo-validate` to ensure that your xml validates properly.

The last thing we need is for the client to have the proper
arch group membership. For this, we will make use of the
:ref:`unsorted-dynamic_groups` capabilities of the Probes plugin. Add
Probes to your plugins line in ``bcfg2.conf`` and create the Probe.

.. code-block:: sh

    root@lucid:~# grep plugins /etc/bcfg2.conf
    plugins = Base,Bundler,Cfg,Metadata,Packages,Probes,Rules,SSHbase
    root@lucid:~# mkdir /var/lib/bcfg2/Probes
    root@lucid:~# cat /var/lib/bcfg2/Probes/groups
    #!/bin/sh

    echo "group:`uname -m`"

Now we restart the bcfg2-server::

    /etc/init.d/bcfg2-server restart

If you tail ``/var/log/syslog`` now, you will see the Packages plugin in
action, updating the cache.

Start managing packages
+++++++++++++++++++++++

Add a base-packages bundle. Let's see what happens when we just populate
it with the *yum* package.

.. code-block:: xml

    root@lucid:~# cat /var/lib/bcfg2/Bundler/base-packages.xml
    <Bundle name='base-packages'>
            <Package name='yum'/>
    </Bundle>

You need to reference the bundle from your Metadata. The resulting
profile group might look something like this

.. code-block:: xml

    <Group profile='true' public='true' default='true' name='basic'>
       <Bundle name='base-packages'/>
       <Group name='centos5.4'/>
    </Group>

Now if we run the client, we can see what this has done for us.::

    [root@centos ~]# bcfg2 -vqn
    Running probe groups
    Probe groups has result:
    x86_64
    Loaded plugins: fastestmirror
    Loading mirror speeds from cached hostfile
    Excluding Packages in global exclude list
    Finished
    Loaded tool drivers:
     Action       Chkconfig  POSIX        YUMng
	    Package pam failed verification.

    Phase: initial
    Correct entries:        94
    Incorrect entries:      1
    Total managed entries:  95
    Unmanaged entries:      113

    In dryrun mode: suppressing entry installation for:
      Package:pam

    Phase: final
    Correct entries:        94
    Incorrect entries:      1
     Package:pam
    Total managed entries:  95
    Unmanaged entries:      113

Interesting, our **pam** package failed verification. What does this
mean? Let's have a look::

    [root@centos ~]# rpm --verify pam
    ....L...  c /etc/pam.d/system-auth

Sigh, it looks like the default RPM install for pam fails to verify
using its own verification process (trust me, it's not the only one). At
any rate, I was able to get rid of this particular issue by removing the
symlink and running ``yum reinstall pam``.

As you can see, the Packages plugin has generated the dependencies
required for the yum package automatically. The ultimate goal should
be to move all the packages from the **Unmanaged** entries section to
the **Managed** entries section. So, what exactly *are* those Unmanaged
entries?::

    [root@centos ~]# bcfg2 -veqn
    Running probe groups
    Probe groups has result:
    x86_64
    Loaded plugins: fastestmirror
    Loading mirror speeds from cached hostfile
    Excluding Packages in global exclude list
    Finished
    Loaded tool drivers:
     Action       Chkconfig  POSIX        YUMng
    Extra Package openssh-clients 4.3p2-36.el5_4.4.x86_64.
    Extra Package libuser 0.54.7-2.1el5_4.1.x86_64.
    ...

    Phase: initial
    Correct entries:        95
    Incorrect entries:      0
    Total managed entries:  95
    Unmanaged entries:      113


    Phase: final
    Correct entries:        95
    Incorrect entries:      0
    Total managed entries:  95
    Unmanaged entries:      113
     Package:at
     Package:avahi
     Package:avahi-compat-libdns_sd
     ...

Now you can go through these and continue adding the packages you want
to your Bundle. After a while, I ended up with a minimal bundle that
looks like this

*This section needs to be updated for v1*

Generate service listing
========================

*This section needs to be updated for v1*

DBStats
-------

Setting up Django
+++++++++++++++++

*This section needs to be updated for v1*
